---
- name: BACKUP DES ÉQUIPEMENT CISCO IOS
  hosts: '{{ TARGET }}'
  gather_facts: false
  tasks:
    - name: CRÉER UN DOSSIER OU STOCKER LES FICHIÉES BACKUP AU NIVEAU LOCAL
      ansible.builtin.file:
        path: /home/semaphore/{{ NAME_DIRECTORY }}/{{ inventory_hostname }}
        state: directory
        mode: "0755"

    - name: RECUPERER LES BACKUP À PARTIR DES EQUIPEMENTS
      cisco.ios.ios_config:
        backup: yes
        backup_options:
            dir_path: /home/semaphore/{{ NAME_DIRECTORY }}/{{ inventory_hostname }}
            filename: "{{inventory_hostname}}_{{ lookup('pipe', 'date +%Y-%m-%d-%Hh%Mm')}}.txt"

- name: BACKUP VERS SFTP SERVER (PURE SFTP)
  hosts: localhost
  gather_facts: no
  vars:
    sftp_key: "/home/semaphore/.ssh/id_rsa_sftp"
    local_backup_dir: "/home/semaphore/{{ NAME_DIRECTORY }}"
    remote_backup_dir: "/cisco"  # Chemin relatif car chroot à /data/sftp
  
  tasks:
    - name: CREATION BATCH FILE SFTP
      ansible.builtin.copy:
        dest: "/tmp/sftp_commands.txt"
        content: |
          cd {{ remote_backup_dir }}
          put -r {{ local_backup_dir }}/* .
          quit          

    - name: EXECUTION UPLOAD SFTP
      ansible.builtin.command:
        cmd: >
          sftp -i {{ sftp_key }}
          -o StrictHostKeyChecking=no
          -b /tmp/sftp_commands.txt
          {{ SFTP_USER }}@{{ SFTP_HOST }}          
      register: sftp_result
      changed_when: true

    - name: NETOYER LE BATCH FILE
      ansible.builtin.file:
        path: "/tmp/sftp_commands.txt"
        state: absent

    - name: NETOYER LES BACKUP LOCAL APRÈS UPLOAD
      ansible.builtin.file:
        path: /home/semaphore/{{ NAME_DIRECTORY }}
        state: absent
      when: sftp_result.rc == 0

    - name: Display result
      ansible.builtin.debug:
        msg: "Backup uploaded successfully to {{ SFTP_HOST }}:/data/sftp{{ remote_backup_dir }}"
